<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="www.bible.library.bible.mapper.BibleMapper">
	<resultMap id="rmBibleVO" type="www.bible.library.bible.model.BibleVO">
		<result property="name" column="name" />
		<association property="language" columnPrefix="lang_"
			resultMap="rmLanguageVO" />
	</resultMap>
	
	<resultMap id="rmLanguageVO" type="www.bible.library.bible.model.language.LanguageVO">
		<result property="language" column="lang" />
		<result property="korean" column="korean" />
		<result property="isOriginal" column="original" />
	</resultMap>
	
	<resultMap id="rmBookVO" type="www.bible.library.bible.model.BookVO">
		<result property="pos" column="pos" />
		<result property="shortName" column="short_name" />
		<result property="fullName" column="full_name" />
		<result property="chapterSuffix" column="suffix" />
		<result property="chapterNumber" column="chapter_num" />
		<result property="isNewTestament" column="new_test" />
	</resultMap>
	
	<resultMap id="rmChapterVO" type="www.bible.library.bible.model.ChapterVO">
		<result property="chapter" column="chapter" />
		<association property="bible" columnPrefix="bbl_"
			resultMap="rmBibleVO" />
		<association property="book" columnPrefix="bk_"
			resultMap="rmBookVO" />
		<collection property="versesList" columnPrefix="ver_"
			resultMap="rmVerseVO" />
	</resultMap>
	
	<resultMap id="rmVerseVO" type="www.bible.library.bible.model.VerseVO">
		<result property="verse" column="verse" />
		<result property="contents" column="contents" />
	</resultMap>
	
	
	<!-- public List<BibleVO> listAllBibles(); -->
	<select id="listAllBibles">
		select *
		  from t_bible
	</select>
	<!-- public List<BookVO> listAllBooks(); -->
	<select id="listAllBooks" resultMap="rmBookVO">
		select *
		  from sys_book
	</select>
	
	<!-- public List<BookVO> listAllBooksOf(String bible); -->
	<select id="listAllBooksOf" resultMap="rmBookVO">
		SELECT DISTINCT bk.pos pos,
        		bk.short_name short_name,
	            bk.full_name full_name,
	            bk.suffix suffix,
	            bk.chapter_num chapter_num,
	            bk.new_test new_test
		  FROM sys_book bk
		  LEFT OUTER JOIN t_verse ver
		    ON bk.short_name = ver.book
		 WHERE ver.bible = #{bible}
	</select>
	
	<!-- public LanguageVO getLanguage(String language); -->
	<select id="getLanguage" resultMap="rmLanguageVO">
		select *
		  from sys_lang
		 where lang = #{language}
	</select>
	
	<!-- public ChapterVO getChapterByAddress(@Param("chapter") ChapterDTO chapter); -->
	<select id="getChapterByAddress" resultMap="rmChapterVO">
		SELECT ver.chapter chapter,
				bbl.name bbl_name,
					bbl.language bbl_language,
        		bk.pos bk_pos,
        			bk.short_name bk_short_name,
	            	bk.full_name bk_full_name,
	            	bk.suffix bk_suffix,
	            	bk.chapter_num bk_chapter_num,
	            	bk.new_test bk_new_test,
	            ver.verse ver_verse,
	            	ver.contents ver_contents
		  FROM t_verse ver
		  LEFT OUTER JOIN t_bible bbl
		    ON ver.bible = bbl.name
		  LEFT OUTER JOIN sys_book bk
		    ON ver.book = bk.short_name
		 WHERE ver.bible = #{chapter.bible}
		   AND ver.book = #{chapter.book}
		   AND ver.chapter = ${chapter.chapter}
	</select>
	
	
	<!-- public int insertBiblesToSync(List<BibleVO> insertList); -->
	<insert id="insertBiblesToSync">
		insert into t_bible(name, lang, parsed)
		select sub.*
		  from <foreach open="(" collection="insertList" item="bbl" separator=" union all " close=")">
         	select 
         		#{bbl.name} as name,
         		#{bbl.language.language} as lang,
         		${bbl.parsed}
         </foreach> sub;
	</insert>
	
	
	<!-- public boolean insertVerses(@Param("bible") BibleVO bible,
			@Param("insertList") List<VerseDAO> insertList); -->
	<insert id="insertVerses">
		insert into t_verse(bible, book, chapter, verse, contents)
		select sub.*
		  from <foreach open="(" collection="insertList" item="ver" separator=" union all " close=")">
         	select 
         		#{bible.name} as bible,
         		#{ver.book} as book,
         		#{ver.chapter} as chapter,
         		#{ver.verse} as verse,
         		#{ver.contents} as contents
         </foreach> sub;
	</insert>
	
	
	<!-- public boolean deleteBiblesToSync(List<BibleVO> deleteList); -->
	<delete id="deleteBiblesToSync">
		delete bbl.*
		  from t_bible bbl
		 where bbl.name in
		<foreach open="(" collection="deleteList" item="bbl" separator=", " close=")">
			#{bbl.name}
		</foreach>;
	</delete>
</mapper>
